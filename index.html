<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PSAS by:SALIM - Secure Exam V3</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
/* 1. ANTI-PRINT */
@media print {
    html, body { display: none !important; }
}

/* Nonaktifkan pemilihan teks */
body { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }

/* ===== GLOBAL ===== */
body { margin:0; font-family:'Poppins',sans-serif; background:#e2e8f0; color:#333; position: relative; }
.container { max-width:900px; margin:auto; padding:20px; transition: padding-bottom 0.3s ease-out; position: relative; z-index: 2; } 
.card { background:#fff; padding:25px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition:0.3s; }
.hide { display:none !important; } 
h2,h3{margin-bottom:15px;}
input,textarea,select{border:1px solid #ccc; border-radius:8px; padding:10px; font-size:15px;}

/* EFEK BLUR SAAT PINDAH APP */
body.blurred {
    filter: blur(10px);
    pointer-events: none;
}

/* WATERMARK NAMA SISWA */
#watermarkOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none;
    display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center;
    opacity: 0.06;
    overflow: hidden;
    transform: rotate(-15deg);
}
.watermark-text {
    font-size: 20px; font-weight: bold; color: #000; margin: 50px;
}

/* ===== BUTTONS ===== */
.btn{ padding:10px 20px; border:none; border-radius:10px; cursor:pointer; font-size:15px; margin:5px; transition:0.2s; }
.btn-primary{ background:#4f46e5; color:#fff; }
.btn-primary:hover{ background:#4338ca; }
.btn-secondary{ background:#6b7280; color:#fff; }
.btn-secondary:hover{ background:#4b5563; }
.btn-danger{ background:#ef4444; color:#fff; }
.btn-danger:hover{ background:#b91c1c; }
.btn:active{ transform:scale(0.93); transition:0.1s; }

.number-list { margin-bottom:20px; display:flex; flex-wrap:wrap; gap:5px; transition: all 0.3s ease; }
.num-btn { width:40px; height:40px; display:flex; justify-content:center; align-items:center; background:#d1d5db; border-radius:8px; font-weight:bold; cursor:pointer; border:2px solid transparent; transition:0.2s; }
.num-btn:hover{ background:#9ca3af; }
.num-active { background:#4f46e5; color:#fff; border-color:#4338ca; }
.num-btn.answered { background-color: #10b981; color: white; border-color: #059669; }
.num-btn.unanswered { background-color: #d1d5db; color: #333; border-color: #9ca3af; }

.slide-left{ animation: slideLeft 0.3s ease; }
@keyframes slideLeft{ from{opacity:0; transform:translateX(40px);} to{opacity:1; transform:translateX(0);} }
.slide-right{ animation: slideRight 0.3s ease; }
@keyframes slideRight{ from{opacity:0; transform:translateX(-40px);} to{opacity:1; transform:translateX(0);} }

@media(max-width:600px){ .number-list{justify-content:center;} .btn{width:100%; margin:5px 0;} }

/* === TOAST === */
.toast {
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(6px); background: rgba(0,0,0,0.3); z-index: 50000; 
}
.toast.hidden { display: none; }
.toast-content {
    background: rgba(255,255,255,0.95); padding: 20px 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 25px rgba(0,0,0,0.3);
}
.toast-content button { margin-top: 10px; padding: 8px 15px; border: none; border-radius: 6px; background: #0074ff; color: white; cursor: pointer; }

/* === MODALS (CONFIRM & UNLOCK) === */
.confirm {
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px); background: rgba(0,0,0,0.7); z-index: 10000;
}
.confirm.hidden { display: none; }
.confirm-content {
    background: rgba(255,255,255,0.95); padding: 25px; border-radius: 14px; width: 320px; text-align: center; box-shadow: 0 4px 25px rgba(0,0,0,0.3);
}
.btn-row { margin-top: 15px; display: flex; justify-content: center; gap: 20px; }
.btn-row button { padding: 8px 18px; border: none; border-radius: 6px; cursor: pointer; background: #007bff; color: white; }
.btn-row button:last-child { background: #666; }

/* === KAMERA CSS === */
#cameraContainer {
    display: none; width: 150px; height: 130px; 
    background-color: #000;
    border: 2px solid #333; border-radius: 8px; overflow: hidden; flex-shrink: 0; position: relative;
}
#faceIndicator {
    position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; border-radius: 50%;
    background-color: red; z-index: 10; border: 1px solid white;
}
#webcam { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

#cameraStatus {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: rgba(0,0,0,0.6); color: white; font-size: 10px; text-align: center; padding: 3px 0; font-weight: bold;
}

.header-content { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
@media(max-width: 600px) {
    .header-content { align-items: center; }
    #cameraContainer { width: 110px; height: 95px; }
}

/* ===== VIRTUAL KEYBOARD ===== */
#virtualKeyboard {
    position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1c1c1e;
    padding: 10px 3px 25px 3px; z-index: 10001; display: none; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5); user-select: none;
}
.keyboard-layout { display: none; width: 100%; max-width: 800px; margin: 0 auto; }
.keyboard-layout.active { display: block; }
.keyboard-row { display: flex; justify-content: center; margin-bottom: 8px; gap: 6px; }
.key-btn {
    flex-grow: 1; height: 46px; background-color: #4a4a4c; color: #fff; border: none; border-radius: 5px;
    font-size: 22px; font-weight: 400; cursor: pointer; display: flex; justify-content: center; align-items: center;
    box-shadow: 0 1px 0 #000; transition: all 0.1s; text-transform: none;
}
.key-btn:active { background-color: #6e6e70; transform: translateY(1px); box-shadow: none; }
.key-btn.modifier { background-color: #3a3a3c; font-size: 16px; font-weight: bold; flex-grow: 1.5; }
.key-btn.space { flex-grow: 4; background-color: #4a4a4c; font-size: 16px; }
.key-btn.enter { background-color: #007AFF; color: white; flex-grow: 1.5; }
.key-btn.enter:active { background-color: #005ecb; }
.key-btn.shift-active { background-color: #fff !important; color: #000 !important; }
.key-btn.caps-active { background-color: #fff !important; color: #000 !important; border-bottom: 4px solid #007AFF; }
</style>
</head>
<body>

<div id="toast" class="toast hidden">
    <div class="toast-content">
        <p id="toastMessage"></p>
        <button onclick="closeToast()">OK</button>
    </div>
</div>

<div id="confirmBox" class="confirm hidden">
    <div class="confirm-content">
        <p id="confirmMessage">Apa kamu yakin mengumpulkan?</p>
        <div class="btn-row">
            <button id="confirmYes">Ya</button>
            <button id="confirmNo">Tidak</button>
        </div>
    </div>
</div>

<div id="unlockModal" class="confirm hidden" style="z-index: 20000;">
    <div class="confirm-content">
        <h3 style="color: #d9534f; margin-top:0;">WAJAH TIDAK TERDETEKSI!</h3>
        <p>Sudah 3x peringatan.<br>Panggil Guru Pengawas untuk membuka kunci.</p>
        <input type="password" id="unlockPassword" placeholder="Password Guru (Face)" 
            style="margin: 15px 0; width: 80%; padding: 10px; text-align: center; border: 2px solid #ccc;" autocomplete="off">
        <div class="btn-row">
            <button onclick="checkUnlockPassword()" style="background: #10b981;">Buka Kunci</button>
        </div>
    </div>
</div>

<div id="fullscreenViolationModal" class="confirm hidden" style="z-index: 30000;">
    <div class="confirm-content">
        <h3 style="color: red; margin-top:0;">PELANGGARAN !!!</h3>
        <p>Kamu melakukan pelanggaran peraturan</p>
        <p style="font-size:13px;">Masukkan Password Guru untuk melanjutkan tanpa mengulang.</p>
        
        <input type="password" id="fsUnlockPassword" placeholder="Password Guru (Fullscreen)" 
            style="margin: 15px 0; width: 80%; padding: 10px; text-align: center; border: 2px solid #red;" autocomplete="off">
        
        <div class="btn-row">
            <button onclick="verifyFullscreenOverride()" style="background: #007bff;">OK</button>
            <button onclick="window.location.reload()" style="background: #666;">Ulang Awal</button>
        </div>
    </div>
</div>

<div id="watermarkOverlay"></div>

<div class="container">
    <div id="startPage" class="card">
        <h2 style="display: flex; align-items: center;">
            <img src="logo.png" alt="Logo" style="width: 50px; height: 50px; margin-right: 10px;" onerror="this.style.display='none'">
            SMP Negeri 3 Babat
        </h2>
        <h3 align="center">Penilaian Sumatif Akhir Semester<br>Tahun Pelajaran 2025/2026</h3>
        
        <div style="background-color: papayawhip; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 80%; max-width: 600px; text-align: justify; margin: 20px auto;">
            <span style="font-weight: bold; color: #0066cc;">Mata Pelajaran:</span> <b>Koding / KKA</b><br>
            <span style="font-weight: bold; color: #0066cc;">Guru Pengampu:</span><br>
            1) Salim Ubaidillah, S.Kom.<br>
            2) M. Izzul Haq, S.Pd.<br>
            <span style="font-weight: bold; color: #0066cc;">Hari & Tanggal:</span><br>Senin, 1 Desember 2025<br>
            <span style="font-weight: bold; color: #0066cc;">Waktu:</span> 30 Menit
        </div>

        <div style="background-color: lightblue; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 80%; max-width: 600px; text-align: justify; margin: 20px auto;">
            <label for="nama">Nama:</label><br>
            <input id="nama" type="text" placeholder="Masukkan nama" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;"><br>
            <div id="nameError" style="color: red; font-size: 12px; display: none;">Nama harus diisi</div><br>
            <label for="kelas">Kelas:</label><br>
            <select id="kelas" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
                <option value="" disabled selected>Pilih Kelas</option>
                <option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="7D">7D</option>
            </select><br>
            <div id="classError" style="color: red; font-size: 12px; display: none;">Kelas harus dipilih</div>
        </div>

        <div style="background-color: lightcyan; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 80%; max-width: 600px; text-align: justify; margin: 20px auto;">
            <h3 style="text-align: center; color: #333;">Peraturan Sumatif</h3>
            <ol style="font-size: 16px; color: #555; line-height: 1.6;">
                <li>Saya berjanji akan mengerjakan sendiri dan tidak mencontek.</li>
                <li>Saya memahami sumatif hanya bisa dikerjakan sekali.</li>
                <li>Saya memahami jika keluar aplikasi maka jawaban tidak bisa tersimpan.</li>
                <li><b>DILARANG KELUAR APLIKASI</b>. Keluar berarti ulang dari awal.</li>
                <li><b>Wajib Mengaktifkan Kamera</b> selama ujian berlangsung.</li>
                <li><b>Ai Tracking:</b> Jika wajah tidak terlihat 3 detik, akan muncul peringatan. 3x Peringatan = TERKUNCI.</li>
            </ol>
            <p style="font-style: italic; color: #888; font-size: 16px; line-height: 1.6;">Pastikan kamu sudah siap sebelum memulai sumatif ini. Berdoalah<br>Good Luck!!!</p>
        </div>

        <div>
            <input type="checkbox" id="agreeCheckbox">
            <label for="agreeCheckbox" style="font-size: 14px; color: #555;">Saya setuju dan memahami aturan tersebut</label>
        </div>
        <div id="agreeError" style="color: red; font-size: 12px; display: none;">Persetujuan harus dicentang</div><br>
        <button id="startButton" class="btn btn-primary" onclick="mulaiKuis()">Mulai Kuis</button>
    </div>

    <div id="quizPage" class="hide">
        <div class="card">
            <div class="header-content">
                <div class="text-info">
                    <h2 style="margin-top:0;">PSAS Koding / KKA</h2>
                    <p>Waktu tersisa: <span id="timer">30:00</span></p>
                    <p>Total soal: <b><span id="totalSoal"></span></b></p>
                </div>
                <div id="cameraContainer">
                    <div id="faceIndicator"></div>
                    <video id="webcam" autoplay playsinline muted></video>
                    <div id="cameraStatus">Menunggu...</div>
                </div>
            </div>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <button id="toggleNumberList" class="btn btn-secondary" onclick="toggleNumberList()">Sembunyikan Nomor Soal</button>
            <div class="number-list" id="numberList"></div>
        </div>
        <br>
        <div id="questionCard" class="card"></div>
        <br>
        <div id="navButtons" style="display: flex; justify-content: space-between; gap: 10px;">
            <button class="btn btn-secondary" id="btn-sebelumnya" onclick="nav(-1)" disabled>Sebelumnya</button>
            <button class="btn btn-danger" id="btn-selesai" style="display: none;" onclick="selesaiKuis()">Selesai</button>
            <button class="btn btn-secondary" id="btn-selanjutnya" onclick="nav(1)">Selanjutnya</button>
        </div>
    </div>

    <div id="donePage" class="card hide">
        <h2>Terima kasih</h2>
        <p>Kamu telah mengerjakan dan tidak dapat mengulangi lagi. Semoga Sukses!!!</p>
    </div>
</div>

<div id="virtualKeyboard">
    <div id="layout-qwerty" class="keyboard-layout active">
        <div class="keyboard-row">
            <div class="key-btn" data-key="q">q</div><div class="key-btn" data-key="w">w</div><div class="key-btn" data-key="e">e</div><div class="key-btn" data-key="r">r</div><div class="key-btn" data-key="t">t</div><div class="key-btn" data-key="y">y</div><div class="key-btn" data-key="u">u</div><div class="key-btn" data-key="i">i</div><div class="key-btn" data-key="o">o</div><div class="key-btn" data-key="p">p</div>
        </div>
        <div class="keyboard-row">
            <div class="key-btn" data-key="a">a</div><div class="key-btn" data-key="s">s</div><div class="key-btn" data-key="d">d</div><div class="key-btn" data-key="f">f</div><div class="key-btn" data-key="g">g</div><div class="key-btn" data-key="h">h</div><div class="key-btn" data-key="j">j</div><div class="key-btn" data-key="k">k</div><div class="key-btn" data-key="l">l</div>
        </div>
        <div class="keyboard-row">
            <div class="key-btn modifier shift" data-key="shift"><span id="shiftIcon">⇧</span></div>
            <div class="key-btn" data-key="z">z</div><div class="key-btn" data-key="x">x</div><div class="key-btn" data-key="c">c</div><div class="key-btn" data-key="v">v</div><div class="key-btn" data-key="b">b</div><div class="key-btn" data-key="n">n</div><div class="key-btn" data-key="m">m</div>
            <div class="key-btn modifier backspace" data-key="backspace">⌫</div>
        </div>
        <div class="keyboard-row">
            <div class="key-btn modifier" data-key="toggle-symbol">?123</div><div class="key-btn" data-key=",">,</div><div class="key-btn space" data-key=" ">Space</div><div class="key-btn" data-key=".">.</div><div class="key-btn enter" data-key="enter">↵</div>
        </div>
    </div>
    <div id="layout-symbol" class="keyboard-layout">
        <div class="keyboard-row">
            <div class="key-btn" data-key="1">1</div><div class="key-btn" data-key="2">2</div><div class="key-btn" data-key="3">3</div><div class="key-btn" data-key="4">4</div><div class="key-btn" data-key="5">5</div><div class="key-btn" data-key="6">6</div><div class="key-btn" data-key="7">7</div><div class="key-btn" data-key="8">8</div><div class="key-btn" data-key="9">9</div><div class="key-btn" data-key="0">0</div>
        </div>
        <div class="keyboard-row">
            <div class="key-btn" data-key="@">@</div><div class="key-btn" data-key="#">#</div><div class="key-btn" data-key="$">$</div><div class="key-btn" data-key="%">%</div><div class="key-btn" data-key="&">&</div><div class="key-btn" data-key="*">*</div><div class="key-btn" data-key="(">(</div><div class="key-btn" data-key=")">)</div><div class="key-btn" data-key="-">-</div><div class="key-btn" data-key="+">+</div>
        </div>
        <div class="keyboard-row">
            <div class="key-btn modifier" data-key="toggle-symbol2">ABC</div><div class="key-btn" data-key="/">/</div><div class="key-btn" data-key=":">:</div><div class="key-btn" data-key=";">;</div><div class="key-btn" data-key="`">`</div><div class="key-btn" data-key="~">~</div><div class="key-btn" data-key="|">|</div><div class="key-btn modifier backspace" data-key="backspace">⌫</div>
        </div>
        <div class="keyboard-row">
            <div class="key-btn modifier" data-key="toggle-symbol">?123</div><div class="key-btn" data-key=",">,</div><div class="key-btn space" data-key=" ">Space</div><div class="key-btn" data-key=".">.</div><div class="key-btn enter" data-key="enter">↵</div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
const firebaseConfig = { databaseURL: "https://uas25-smp3-default-rtdb.asia-southeast1.firebasedatabase.app/" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window.saveToFirebase = (p, d) => set(ref(db, p), d);
window.updateFirebase = (p, d) => update(ref(db, p), d);
</script>

<script>
// ================= GLOBAL VARIABLES =================
const mainContainer = document.querySelector('.container');
const originalPaddingBottom = 20; 
let curr = 0;
let waktu = 30 * 60;
let timerInterval;
let DB = { nama: "", kelas: "", jawaban: {}, skor: 0 };
let isFinishedQuiz = false;
let mediaStream = null;

// ================= FACE DETECTION VARIABLES =================
let faceModel = null;
let faceCheckInterval = null;
let faceWarningCount = 0;
let faceMissingSeconds = 0;
const MAX_FACE_WARNINGS = 3;
const faceIndicator = document.getElementById('faceIndicator');
const cameraStatus = document.getElementById('cameraStatus');

// ================= VIRTUAL KEYBOARD VARIABLES =================
let activeTextarea = null;
let isShift = false;    
let isCapsLock = false;  
let currentLayout = 'qwerty';

const keyboard = document.getElementById('virtualKeyboard');
const qwertyLayout = document.getElementById('layout-qwerty');
const symbolLayout = document.getElementById('layout-symbol');

// ================= ANTI-SCREENSHOT & CHEAT =================

document.addEventListener('contextmenu', event => event.preventDefault());

document.addEventListener('keyup', (e) => {
    if (e.key === 'PrintScreen') {
        navigator.clipboard.writeText(''); 
        showToast("PERINGATAN: DILARANG MELAKUKAN SCREENSHOT!");
    }
});

window.addEventListener('blur', () => {
    if (!isFinishedQuiz && !document.getElementById('startPage').classList.contains('hide')) {
        document.body.classList.add('blurred');
    }
});

window.addEventListener('focus', () => {
    document.body.classList.remove('blurred');
});


// ================= LOAD FACE MODEL =================
async function loadFaceModel() {
    try {
        faceModel = await blazeface.load();
        console.log("Model Wajah Siap");
        cameraStatus.textContent = "Sistem AI Siap";
    } catch (e) {
        console.error("Gagal memuat model wajah", e);
        showToast("Gagal memuat AI Wajah. Periksa Koneksi Internet.");
    }
}
window.onload = () => { loadFaceModel(); }

// ================= DATA SOAL =================
let pg = [
    { text: "Berikut ini pernyataan yang benar tentang apa yang dimaksud dengan algoritma adalah...", options: ["Bahasa pemrograman khusus","Kumpulan instruksi acak","Urutan langkah sistematis untuk menyelesaikan masalah","Kode komputer"], answer: 2 },
    { text: "Proses penulisan algoritma ke dalam bahasa yang dipahami komputer disebut...", options: ["Writing","Pemrograman","Pengulangan","Percabangan"], answer: 1 },
    { text: "Scratch merupakan bahasa pemrograman yang berbasis...", options: ["Teks","Simbol","Blok visual","Alur logika"], answer: 2 },
    { text: "Blok “move 10 steps” dalam scratch digunakan untuk...", options: ["Menghapus sprite","Mengubah kostum","Menggerakan sprite","Menampilkan suara"], answer: 2 },
    { text: "Simbol belah ketupat dalam flowchart digunakan untuk menyatakan...", options: ["Input/output","Proses","Kondisi","Awal/akhir"], answer: 2 },
    { text: "Dalam Scratch, sprite adalah...", options: ["Latar belakang program","Kumpulan blok","Karakter atau objek dalam proyek","Nama variabel"], answer: 2 },
    { text: "Fungsi dari blok “if on edge, bounce” adalah...", options: ["Menyembunyikan sprite","Menghapus latar","Memantulkan sprite dari tepi","Memulai skrip"], answer: 2 },
    { text: "Blok “say hello! For 2 seconds” digunakan untuk...", options: ["Menyapa pengguna selama 2 detik","Mengubah sprite","Mengubah ukuran sprite","Menambah suara"], answer: 0 },
    { text: "Jika kalian ingin sprite berbicara saat diklik maka blok yang digunakan adalah...", options: ["When green flag clicked","When this sprite clicked","Repeat until","Play sound"], answer: 1 },
    { text: "Fungsi dari blok “repeat 10” adalah...", options: ["Mengulang selamanya","Mengulang sebanyak 10 kali","Mengulang hingga kondisi benar","Menyimpan variabel"], answer: 1 },
    { text: "Dalam Scratch, broadcast digunakan untuk...", options: ["Menggerakan sprite","Menyimpan data","Mengirim pesan antar sprite","Mengubah ekspresi"], answer: 2 },
    { text: "Blok yang digunakan untuk membuat percabangan adalah...", options: ["Forever","Glide","If...then","Broadcast"], answer: 2 },
    { text: "Variabel digunakan untuk...", options: ["Mengganti suara","Menyimpan nilai data","Menampilkan sprite","Mengubah warna"], answer: 1 },
    { text: "Blok “join [apple] [banana]” menghasilkan...", options: ["applebanana","bananaapple","apple banana","banana apple"], answer: 0 },
    { text: "Untuk memutar suara sampai selesai, kalian dapat menggunakan blok...", options: ["Play sound until done","Start sound","Stop all sounds","Say for 2 seconds"], answer: 0 }
];
let pgk = [
    { text: "Berikut ini yang merupakan pengertian yang benar tentang algoritma adalah...", options: ["Urutan langkah sistematis untuk menyelesaikan masalah", "Kumpulan instruksi acak", "Proses penyusunan kode komputer secara langsung", "Kumpulan instruksi yang dapat dieksekusi oleh komputer"], answer: [0, 3] },
    { text: "Dalam Scratch, sprite dapat memiliki berbagai fungsi. Berikut yang merupakan fungsi sprite dalam Scratch adalah...", options: ["Sprite berfungsi sebagai objek atau karakter dalam proyek", "Sprite digunakan untuk menyimpan variabel", "Sprite dapat bergerak dan berinteraksi dengan blok kode", "Sprite berfungsi sebagai latar belakang program"], answer: [0, 2] },
    { text: "Fungsi dari blok 'repeat' dan 'if...then' adalah...", options: ["Blok 'repeat' digunakan untuk mengulang langkah tertentu beberapa kali", "Blok 'repeat' digunakan untuk menjalankan perulangan tanpa batas", "Blok 'if...then' digunakan untuk memeriksa suatu kondisi dan melaksanakan aksi jika kondisi tersebut benar", "Blok 'if...then' digunakan untuk menghentikan perulangan"], answer: [0, 2] },
    { text: "Dalam pemrograman Scratch, blok 'broadcast' digunakan untuk...", options: ["Mengirim pesan antar sprite untuk koordinasi", "Mengubah ekspresi visual dari sprite", "Memulai eksekusi dari suatu event atau skrip", "Menyimpan data yang digunakan antar sprite"], answer: [0, 2] },
    { text: "Fungsi dari blok 'say [teks] for [x] seconds' dan 'play sound [nama suara] until done' adalah...", options: ["Blok 'say' digunakan untuk menampilkan teks atau pesan dalam waktu tertentu", "Blok 'say' digunakan untuk memutar suara", "Blok 'play sound' digunakan untuk memutar suara sampai selesai", "Blok 'play sound' digunakan untuk mengubah tampilan sprite"], answer: [0, 2] }
];
let essay = [
    { text: "Mengapa pengelolaan data di era digital sekarang menjadi sangat penting? Berikan contoh manfaatnya!" },
    { text: "Jika tiba-tiba lampu rumah kalian mati, langkah apa yang kalian lakukan? Buat langkah-langkah sistematis!" },
    { text: "Bagaimana penggunaan variabel dapat membantu dalam pembuatan game di Scratch?" },
    { text: "Perhatikan langkah-langkah mencuci tangan berikut ini!<br>a. Keringkan tangan dengan tisu<br>b. Bilas tangan hingga bersih<br>c. Basahi tangan dengan air<br>d. Gosok tangan dengan sabun selama 20 detik<br>e. Tutup keran dengan tangan beralaskan tisu<br>Apakah langkah-langkah mencuci tangan tersebut sudah sistematis? Jika belum, susun ulang yang benar!" },
    { text: "Apa fungsi dari blok repeat until dan berikan contohnya?" }
];

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}
shuffle(pg); shuffle(pgk); shuffle(essay);
const questions = [...pg.map(q => ({ type: "pg", ...q })), ...pgk.map(q => ({ type: "pgk", ...q })), ...essay.map(q => ({ type: "essay", ...q }))];

function computeMaxScore() {
    let max = 0;
    for (let i = 0; i < questions.length; i++) { if (questions[i].type === "pg" || questions[i].type === "pgk") max += 2; }
    return max;
}

// ================= KAMERA & AI FUNCTIONS =================
async function startCamera() {
    try {
        const videoElement = document.getElementById('webcam');
        const cameraContainer = document.getElementById('cameraContainer');
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoElement.srcObject = mediaStream;
        cameraContainer.style.display = "block";
        startFaceDetection();
        return true;
    } catch (error) { return false; }
}

function stopCamera() {
    stopFaceDetection(); 
    if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; }
    document.getElementById('cameraContainer').style.display = "none";
}

function startFaceDetection() {
    const video = document.getElementById('webcam');
    if (faceCheckInterval) clearInterval(faceCheckInterval);
    faceCheckInterval = setInterval(async () => {
        if (faceModel && video.readyState === 4) {
            const predictions = await faceModel.estimateFaces(video, false);
            if (predictions.length > 0) {
                faceIndicator.style.backgroundColor = '#10b981'; 
                cameraStatus.style.backgroundColor = 'rgba(16, 185, 129, 0.8)';
                cameraStatus.textContent = "Aman: Wajah Terdeteksi";
                faceMissingSeconds = 0;
            } else {
                faceIndicator.style.backgroundColor = 'red';
                faceMissingSeconds++; 
                let timeLeft = 3 - faceMissingSeconds;
                if (timeLeft > 0) {
                    cameraStatus.style.backgroundColor = 'rgba(255, 165, 0, 0.8)'; 
                    cameraStatus.textContent = `Wajah Tidak Terlihat! (${timeLeft})`;
                } else {
                    cameraStatus.style.backgroundColor = 'rgba(239, 68, 68, 0.8)'; 
                    cameraStatus.textContent = "PERINGATAN!";
                    handleNoFace();
                    faceMissingSeconds = 0; 
                }
            }
        }
    }, 1000);
}

function stopFaceDetection() { if (faceCheckInterval) clearInterval(faceCheckInterval); }

function handleNoFace() {
    faceWarningCount++;
    showToast(`PERINGATAN: Wajah tidak terdeteksi! (${faceWarningCount}/${MAX_FACE_WARNINGS})`);
    if (faceWarningCount >= MAX_FACE_WARNINGS) {
        stopFaceDetection();
        document.getElementById('unlockModal').classList.remove('hidden');
    }
}

// PASSWORD UNTUK FACE TRACKING (GURU 123)
window.checkUnlockPassword = function() {
    const passInput = document.getElementById('unlockPassword');
    if (passInput.value === "guru123") {
        faceWarningCount = 0;
        faceMissingSeconds = 0;
        passInput.value = "";
        document.getElementById('unlockModal').classList.add('hidden');
        showToast("Akses dibuka kembali.");
        startFaceDetection();
    } else {
        showToast("Password Salah! Silakan coba lagi.");
        passInput.value = ""; passInput.focus(); 
    }
}

// UPDATE 3: PASSWORD UNTUK FULLSCREEN (GURU 456)
window.verifyFullscreenOverride = function() {
    const passInput = document.getElementById('fsUnlockPassword');
    if (passInput.value === "guru456") {
        document.getElementById('fullscreenViolationModal').classList.add('hidden');
        passInput.value = "";
        // Coba masuk fullscreen lagi
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        showToast("Selamat mengerjakan");
    } else {
        showToast("Password Salah");
        passInput.value = ""; passInput.focus();
    }
}

// ================= QUIZ LOGIC =================
async function mulaiKuis() {
    let valid = true;
    document.getElementById("nameError").style.display = "none";
    document.getElementById("classError").style.display = "none";
    document.getElementById("agreeError").style.display = "none";
    if (!nama.value) { document.getElementById("nameError").style.display = "block"; valid = false; }
    if (!kelas.value) { document.getElementById("classError").style.display = "block"; valid = false; }
    if (!document.getElementById("agreeCheckbox").checked) { document.getElementById("agreeError").style.display = "block"; valid = false; }
    if (!valid) return;

    if (!faceModel) {
        showToast("Sedang memuat AI Wajah... Tunggu sebentar.");
        await new Promise(r => setTimeout(r, 2000));
        if(!faceModel) { showToast("Gagal memuat AI. Cek koneksi internet."); return; }
    }
    showToast("Meminta akses kamera...");
    const cameraAllowed = await startCamera();
    if (!cameraAllowed) { closeToast(); showToast("Akses kamera WAJIB diizinkan untuk memulai kuis!"); return; }
    closeToast();

    // START FULLSCREEN
    if (document.documentElement.requestFullscreen) { document.documentElement.requestFullscreen(); }
    else if (document.documentElement.mozRequestFullScreen) { document.documentElement.mozRequestFullScreen(); }
    else if (document.documentElement.webkitRequestFullscreen) { document.documentElement.webkitRequestFullscreen(); }
    else if (document.documentElement.msRequestFullscreen) { document.documentElement.msRequestFullscreen(); }
    
    DB.nama = nama.value; DB.kelas = kelas.value;
    saveToFirebase(`jawaban/${DB.kelas}/${DB.nama}`, DB);

    // GENERATE WATERMARK
    const watermarkContainer = document.getElementById('watermarkOverlay');
    watermarkContainer.innerHTML = "";
    for(let i=0; i<15; i++) {
        let span = document.createElement("span");
        span.className = "watermark-text";
        span.textContent = `${DB.nama} - ${DB.kelas}`;
        watermarkContainer.appendChild(span);
    }

    document.getElementById("startPage").classList.add("hide");
    document.getElementById("quizPage").classList.remove("hide");
    loadNumberList(); loadQuestion(curr); mulaiTimer();
}

// --- EVENT LISTENER KELUAR FULLSCREEN (MODAL + PASS) ---
function handleFullscreenChange() {
    const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
    // Jika keluar fullscreen DAN kuis belum selesai DAN modal pelanggaran belum muncul
    if (!isFullscreen && !isFinishedQuiz) {
        const modal = document.getElementById('fullscreenViolationModal');
        if(modal.classList.contains('hidden')){
            modal.classList.remove('hidden');
        }
    }
}
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('msfullscreenchange', handleFullscreenChange);

// FUNGSI LAINNYA
function toggleNumberList() {
    const list = document.getElementById("numberList");
    const btn = document.getElementById("toggleNumberList");
    if(list && btn) {
        list.classList.toggle("hide");
        btn.textContent = list.classList.contains("hide") ? "Tampilkan Nomor Soal" : "Sembunyikan Nomor Soal";
    }
}

function loadNumberList() {
    const list = document.getElementById("numberList");
    document.getElementById("totalSoal").textContent = questions.length;
    list.innerHTML = "";
    for (let i = 0; i < questions.length; i++) {
        let btn = document.createElement("div");
        btn.className = "num-btn"; btn.textContent = i + 1;
        if (DB.jawaban[i] !== undefined && DB.jawaban[i] !== null && DB.jawaban[i] !== "" && (Array.isArray(DB.jawaban[i]) ? DB.jawaban[i].length > 0 : true)) {
            btn.classList.add("answered");
        } else { btn.classList.add("unanswered"); }
        btn.onclick = () => { curr = i; loadQuestion(curr); };
        list.appendChild(btn);
    }
    updateActiveNumber();
}
function updateActiveNumber() { document.querySelectorAll(".num-btn").forEach((b, i) => { b.classList.toggle("num-active", i === curr); }); }

function simpanJawaban(no, value) {
    DB.jawaban[no] = value;
	updateFirebase(`jawaban/${DB.kelas}/${DB.nama}/jawaban`, DB.jawaban);
    loadNumberList();
}
function updatePGK(no) {
    const boxes = document.querySelectorAll(`input[name='q${no}']`);
    const selected = [];
    boxes.forEach(b => { if (b.checked) selected.push(Number(b.value)); });
    simpanJawaban(no, selected);
}

function loadQuestion(i) {
    const q = questions[i];
    let html = `<h3>${i + 1}. ${q.text}</h3><br>`;
    if (q.type === "pg") {
        q.options.forEach((o, idx) => { html += `<label style="display:block;margin-bottom:8px;"><input type="radio" name="q${i}" value="${idx}" ${DB.jawaban[i] == idx ? "checked" : ""} onchange="simpanJawaban(${i}, ${idx})"> ${o}</label>`; });
    } else if (q.type === "pgk") {
        q.options.forEach((o, idx) => { const checked = DB.jawaban[i]?.includes(idx) ? "checked" : ""; html += `<label style="display:block;margin-bottom:8px;"><input type="checkbox" name="q${i}" value="${idx}" ${checked} onchange="updatePGK(${i})"> ${o}</label>`; });
    } else if (q.type === "essay") {
        html += `<textarea id="essayQ${i}" name="q${i}" rows="5" inputmode="none" style="width:100%; padding:10px; font-size:15px;" 
            onfocus="showVirtualKeyboard(this, ${i})" onblur="hideVirtualKeyboardDelayed()"
            oninput="simpanJawaban(${i}, this.value)">${DB.jawaban[i] || ""}</textarea>`;
    }
    document.getElementById("questionCard").innerHTML = html;
    updateActiveNumber();
    document.getElementById("btn-selesai").style.display = (curr === questions.length - 1) ? 'inline-block' : 'none';
    document.getElementById("btn-selanjutnya").style.display = (curr === questions.length - 1) ? 'none' : 'inline-block';
    document.getElementById("btn-sebelumnya").style.display = (curr === 0) ? 'none' : 'inline-block';
    document.getElementById("btn-sebelumnya").disabled = (curr === 0);
}

function nav(step) {
    if (keyboard.style.display === 'block') { hideVirtualKeyboardDelayed(); }
    let old = curr; curr += step;
    if (curr < 0) curr = 0; if (curr >= questions.length) curr = questions.length - 1;
    let card = document.getElementById("questionCard");
    if (curr > old) { card.classList.remove("slide-right"); card.classList.add("slide-left"); }
    else { card.classList.remove("slide-left"); card.classList.add("slide-right"); }
    loadQuestion(curr);
    setTimeout(() => { card.classList.remove("slide-left"); card.classList.remove("slide-right"); }, 300);
}

function mulaiTimer() {
    timerInterval = setInterval(() => {
        waktu--;
        let m = Math.floor(waktu / 60); let s = waktu % 60;
        document.getElementById("timer").textContent = `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        if (waktu <= 0) selesaiKuis();
    }, 1000);
}

function selesaiKuis() {
    let allAnswered = true;
    for (let i = 0; i < questions.length; i++) {
        const q = questions[i]; const j = DB.jawaban[i];
        if (q.type === "pg" && (j===undefined||j===null)) allAnswered=false;
        if (q.type === "pgk" && (!Array.isArray(j)||j.length===0)) allAnswered=false;
        if (q.type === "essay" && (!j||j.trim()==="")) allAnswered=false;
    }
    if (!allAnswered) { showToast("Pastikan semua pertanyaan sudah dijawab."); return; }

    showConfirm((ok) => {
        if (!ok) return;
        isFinishedQuiz = true;
        clearInterval(timerInterval); stopCamera(); keyboard.style.display = 'none';
        let skor = 0;
        for (let i = 0; i < questions.length; i++) {
            const q = questions[i]; const j = DB.jawaban[i];
            if (q.type === "pg" && j == q.answer) skor += 2;
            if (q.type === "pgk" && Array.isArray(j) && j.length === q.answer.length && q.answer.every(x => j.includes(x))) skor += 2;
        }
        const max = computeMaxScore(); const percent = max > 0 ? Math.round((skor / max) * 100) : 0;
        updateFirebase(`jawaban/${DB.kelas}/${DB.nama}`, { skor: skor, persen: percent, jawaban: DB.jawaban });
        document.getElementById("quizPage").classList.add("hide");
        document.getElementById("donePage").classList.remove("hide");
        if (document.fullscreenElement) { document.exitFullscreen().catch(err => console.log(err)); }
    });
}

// ================= TOAST & MODALS =================
function showToast(msg) {
    document.getElementById("toastMessage").textContent = msg;
    document.getElementById("toast").classList.remove("hidden");
}
function closeToast() { document.getElementById("toast").classList.add("hidden"); }
function showConfirm(callback) {
    const box = document.getElementById("confirmBox"); box.classList.remove("hidden");
    document.getElementById("confirmYes").onclick = () => { box.classList.add("hidden"); callback(true); };
    document.getElementById("confirmNo").onclick = () => { box.classList.add("hidden"); callback(false); };
}

// ================= KEYBOARD LOGIC =================
function updateKeys() {
    const showUpper = isShift || isCapsLock;
    document.getElementById('shiftIcon').innerHTML = isCapsLock ? "⇪" : "⇧";
    document.querySelector('.key-btn.shift').className = `key-btn modifier shift ${isCapsLock ? 'caps-active' : (isShift ? 'shift-active' : '')}`;
    document.querySelectorAll('#layout-qwerty .key-btn').forEach(btn => {
        const key = btn.getAttribute('data-key');
        if (key && key.length === 1 && key.match(/[a-zA-Z]/)) btn.textContent = showUpper ? key.toUpperCase() : key.toLowerCase();
    });
}
function toggleLayout() {
    if (currentLayout === 'qwerty') { currentLayout = 'symbol'; qwertyLayout.classList.remove('active'); symbolLayout.classList.add('active'); } 
    else { currentLayout = 'qwerty'; symbolLayout.classList.remove('active'); qwertyLayout.classList.add('active'); }
    showVirtualKeyboard(activeTextarea, curr, true); 
}
function showVirtualKeyboard(textarea, index, isLayoutChange = false) {
    if (textarea) activeTextarea = textarea;
    if (activeTextarea) activeTextarea.setAttribute('inputmode', 'none');
    keyboard.style.display = 'block';
    setTimeout(() => {
        const keyboardHeight = keyboard.offsetHeight;
        const paddingNeeded = keyboardHeight + 80; 
        mainContainer.style.paddingBottom = `${originalPaddingBottom + paddingNeeded}px`; 
        const navButtons = document.getElementById('navButtons'); 
        if (navButtons) {
            const rect = navButtons.getBoundingClientRect();
            const visibleViewportHeight = window.innerHeight - keyboardHeight;
            if (rect.bottom > visibleViewportHeight) {
                const scrollAmount = rect.bottom - visibleViewportHeight + 20;
                window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
            }
        }
    }, isLayoutChange ? 0 : 300); 
    if (!isLayoutChange) { isShift = false; isCapsLock = false; currentLayout = 'qwerty'; qwertyLayout.classList.add('active'); symbolLayout.classList.remove('active'); updateKeys(); }
}
let blurTimeout;
function hideVirtualKeyboardDelayed() {
    blurTimeout = setTimeout(() => {
        if (document.activeElement && keyboard.contains(document.activeElement)) return;
        keyboard.style.display = 'none'; mainContainer.style.paddingBottom = `${originalPaddingBottom}px`; 
        if (activeTextarea) activeTextarea.removeAttribute('inputmode');
    }, 150); 
}
keyboard.addEventListener('mousedown', (e) => { e.preventDefault(); clearTimeout(blurTimeout); });
keyboard.querySelectorAll('.key-btn').forEach(button => {
    button.addEventListener('click', (e) => {
        if (!activeTextarea) return;
        e.preventDefault();
        const key = button.getAttribute('data-key');
        let cursorStart = activeTextarea.selectionStart; let cursorEnd = activeTextarea.selectionEnd;
        let value = activeTextarea.value; let newValue = value;
        if (key === 'backspace') {
            if (cursorStart === cursorEnd) { if (cursorStart > 0) { newValue = value.slice(0, cursorStart - 1) + value.slice(cursorStart); cursorStart--; } } 
            else { newValue = value.slice(0, cursorStart) + value.slice(cursorEnd); }
            cursorEnd = cursorStart;
        } else if (key === 'shift') {
            if (!isShift && !isCapsLock) isShift = true; else if (isShift && !isCapsLock) { isShift=false; isCapsLock=true; } else { isShift=false; isCapsLock=false; }
            updateKeys(); return;
        } else if (key === 'toggle-symbol' || key === 'toggle-symbol2') { toggleLayout(); return; } 
        else if (key === 'enter') { newValue = value.slice(0, cursorStart) + "\n" + value.slice(cursorEnd); cursorStart++; cursorEnd = cursorStart; } 
        else {
            let char = key;
            if (currentLayout === 'qwerty' && key.length === 1) char = (isCapsLock || isShift) ? key.toUpperCase() : key.toLowerCase();
            newValue = value.slice(0, cursorStart) + char + value.slice(cursorEnd); cursorStart += char.length; cursorEnd = cursorStart;
            if (isShift && !isCapsLock && key !== ' ') { isShift = false; updateKeys(); }
        }
        activeTextarea.value = newValue; activeTextarea.setSelectionRange(cursorStart, cursorEnd);
        activeTextarea.dispatchEvent(new Event('input', { bubbles: true })); activeTextarea.focus();
    });
});
</script>
</body>
</html>